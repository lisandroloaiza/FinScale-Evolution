# Gobierno de APIs - Estrategia Corporativa

> **Objetivo**: Establecer pol√≠ticas de dise√±o, versionamiento y lifecycle de APIs  
> **Alcance**: Todas las APIs p√∫blicas (mobile/web) e internas (service-to-service)

---

## üéØ Principios de Dise√±o de APIs

### 1. RESTful Best Practices

```yaml
Standards:
  Protocol: HTTPS only (TLS 1.2+)
  Format: JSON (application/json)
  Naming: 
    - Resources: Plural nouns (/payments, /customers)
    - Actions: HTTP verbs (GET, POST, PUT, DELETE)
  
  HTTP Status Codes:
    200: OK (successful GET/PUT)
    201: Created (successful POST)
    204: No Content (successful DELETE)
    400: Bad Request (validation error)
    401: Unauthorized (missing/invalid token)
    403: Forbidden (insufficient permissions)
    404: Not Found
    429: Too Many Requests (rate limit)
    500: Internal Server Error
    503: Service Unavailable (circuit breaker open)
```

**Ejemplo de Request/Response**:

```http
POST /api/v1/payments HTTP/1.1
Host: api.finscale.com
Authorization: Bearer eyJhbGciOiJSUzI1NiIs...
Content-Type: application/json
Idempotency-Key: 550e8400-e29b-41d4-a716-446655440000

{
  "originator_id": "cust_123",
  "beneficiary": {
    "name": "John Doe",
    "account": "ES9121000418450200051332",
    "bank_code": "BBVAESMM"
  },
  "amount": {
    "value": 500.00,
    "currency": "EUR"
  },
  "description": "Invoice #1234"
}
```

```http
HTTP/1.1 201 Created
Content-Type: application/json
Location: /api/v1/payments/pay_550e8400e29b
X-Request-ID: req_7a8b9c0d1e2f

{
  "id": "pay_550e8400e29b",
  "status": "VALIDATED",
  "created_at": "2024-12-07T10:30:00Z",
  "estimated_settlement": "2024-12-09T10:30:00Z",
  "_links": {
    "self": { "href": "/api/v1/payments/pay_550e8400e29b" },
    "execute": { "href": "/api/v1/payments/pay_550e8400e29b/execute", "method": "POST" },
    "cancel": { "href": "/api/v1/payments/pay_550e8400e29b", "method": "DELETE" }
  }
}
```

---

### 2. API Versioning

**Estrategia**: URL Path versioning (m√°s expl√≠cito)

```yaml
Versioning Policy:
  Format: /api/v{major}/...
  
  Major Version (v1 ‚Üí v2):
    Trigger:
      - Breaking changes (remove field, change type)
      - Cambio de estructura de response
    Lifecycle: 12 meses de soporte paralelo
    
  Minor Version (v1.1):
    Trigger:
      - Nuevos campos (backward compatible)
      - Nuevos endpoints
    Lifecycle: No requiere versi√≥n URL
    Implementation: Feature flags
  
  Patch Version (v1.1.1):
    Trigger:
      - Bug fixes
      - Performance improvements
    Lifecycle: Transparent to clients
```

**Ejemplo de Breaking Change**:

```yaml
# v1 (deprecated en 2025-06-01)
GET /api/v1/payments/pay_123
Response:
  {
    "amount": 500.00,  # ‚ùå Ambiguo (sin currency)
    "currency": "EUR"
  }

# v2 (released 2024-12-01)
GET /api/v2/payments/pay_123
Response:
  {
    "amount": {  # ‚úÖ Structured Money object
      "value": 500.00,
      "currency": "EUR"
    }
  }
```

**Deprecation Notice**:

```http
HTTP/1.1 200 OK
Sunset: Sat, 01 Jun 2025 00:00:00 GMT
Link: </api/v2/payments/pay_123>; rel="alternate"
Deprecation: true

{
  "amount": 500.00,
  "currency": "EUR"
}
```

---

### 3. Rate Limiting

**Pol√≠ticas por Tier**:

| Tier | Rate Limit | Burst | Use Case |
|------|------------|-------|----------|
| **Free** | 10 req/min | 20 | Developers, testing |
| **Basic** | 100 req/min | 200 | Startups |
| **Pro** | 1,000 req/min | 2,000 | SMEs |
| **Enterprise** | 10,000 req/min | 20,000 | Corporate clients |

**Headers de Rate Limit** (RFC 6585):

```http
HTTP/1.1 200 OK
X-RateLimit-Limit: 1000
X-RateLimit-Remaining: 456
X-RateLimit-Reset: 1638878400  # Unix timestamp

# Si excede:
HTTP/1.1 429 Too Many Requests
Retry-After: 60
X-RateLimit-Limit: 1000
X-RateLimit-Remaining: 0
X-RateLimit-Reset: 1638878400

{
  "error": {
    "code": "RATE_LIMIT_EXCEEDED",
    "message": "API rate limit exceeded. Retry after 60 seconds."
  }
}
```

---

### 4. Authentication & Authorization

**OAuth 2.0 + OpenID Connect**:

```yaml
Auth Flow:
  1. Client Credentials (service-to-service):
      - Grant Type: client_credentials
      - Scope: payment:create, payment:read
      - Token TTL: 1 hora
      
  2. Authorization Code (user-facing):
      - Grant Type: authorization_code
      - Scope: payment:create, customer:read
      - Token TTL: 15 minutos
      - Refresh Token: 30 d√≠as

JWT Claims:
  {
    "sub": "user_123",
    "iss": "https://auth.finscale.com",
    "aud": "https://api.finscale.com",
    "exp": 1638878400,
    "iat": 1638874800,
    "scope": "payment:create payment:read",
    "client_id": "app_mobile_v1",
    "tenant_id": "tenant_abc"
  }
```

**Kong OAuth2 Plugin**:

```yaml
plugins:
  - name: oauth2
    config:
      scopes:
        - payment:create
        - payment:read
        - payment:execute
        - customer:read
        - customer:update
      
      mandatory_scope: true
      token_expiration: 3600
      refresh_token_ttl: 2592000  # 30 d√≠as
      
      enable_client_credentials: true
      enable_authorization_code: true
```

---

## ÔøΩ APIs Internas (Service-to-Service)

### gRPC para Comunicaci√≥n S√≠ncrona

**WHY gRPC**: Latencia < 10ms (vs 50ms REST), type-safe con Protobuf, bi-directional streaming

**Servicios usando gRPC**:
- Payment Service ‚Üí TensorFlow Serving (fraud scoring)
- Payment Service ‚Üí Fraud Service (risk evaluation)
- Clearing Service ‚Üí HSM Proxy (cryptographic operations)

**Ejemplo: Payment ‚Üí TensorFlow Serving**

```protobuf
// fraud_detection.proto
syntax = "proto3";

package fraud;

service FraudDetection {
  rpc PredictFraudScore(FraudRequest) returns (FraudResponse);
}

message FraudRequest {
  string payment_id = 1;
  PaymentFeatures features = 2;
}

message PaymentFeatures {
  double amount = 1;
  double velocity_24h = 2;
  double avg_amount_30d = 3;
  float cross_border_flag = 4;
}

message FraudResponse {
  float score = 1;  // 0-100
  string risk_level = 2;  // LOW, MEDIUM, HIGH
  string model_version = 3;
}
```

**Configuraci√≥n gRPC Client** (Java):

```java
@Configuration
public class GrpcClientConfig {
    
    @Bean
    public ManagedChannel tensorflowServingChannel() {
        return ManagedChannelBuilder
            .forAddress("tensorflow-serving.internal", 8500)
            .usePlaintext()  // Internal traffic (mTLS via Istio)
            .keepAliveTime(30, TimeUnit.SECONDS)
            .build();
    }
    
    @Bean
    public FraudDetectionBlockingStub fraudDetectionStub(ManagedChannel channel) {
        return FraudDetectionGrpc.newBlockingStub(channel)
            .withDeadlineAfter(100, TimeUnit.MILLISECONDS);  // Timeout 100ms
    }
}
```

**Pol√≠ticas de Gobierno gRPC**:
- ‚úÖ Timeout m√°ximo: 200ms (evitar bloqueos)
- ‚úÖ Retry policy: Exponential backoff con max 3 attempts
- ‚úÖ Circuit Breaker: Resilience4j wrapper obligatorio
- ‚úÖ Versioning: Protobuf backward compatibility (no breaking changes)

---

### Kafka para Comunicaci√≥n As√≠ncrona

**WHY Kafka**: Desacoplamiento temporal, event sourcing, throughput 1M msg/s

**Topics Principales**:

```yaml
payment-events:
  Description: Eventos de lifecycle de pagos
  Schema Registry: Avro (schema evolution)
  Partitions: 12 (por originator_id hash)
  Replication: 3
  Retention: 30 d√≠as
  
  Event Types:
    - PaymentCreated
    - PaymentValidated
    - PaymentExecuted
    - PaymentFailed
    - PaymentSettled

ledger-events:
  Description: Event Sourcing de movimientos contables
  Schema: Avro
  Partitions: 20 (por account_id hash)
  Replication: 3
  Retention: Infinito (compacted)
  Cleanup Policy: compact

fraud-alerts:
  Description: Alertas de fraude detectado
  Schema: JSON
  Partitions: 6
  Retention: 7 d√≠as
  Consumers: Fraud Service, Compliance Service
```

**Avro Schema Example** (payment-events):

```json
{
  "type": "record",
  "namespace": "com.finscale.payment.events",
  "name": "PaymentCreated",
  "fields": [
    {"name": "payment_id", "type": "string"},
    {"name": "originator_id", "type": "string"},
    {"name": "beneficiary_id", "type": "string"},
    {"name": "amount", "type": {"type": "record", "name": "Money", "fields": [
      {"name": "value", "type": "double"},
      {"name": "currency", "type": "string"}
    ]}},
    {"name": "created_at", "type": "long", "logicalType": "timestamp-millis"},
    {"name": "metadata", "type": {"type": "map", "values": "string"}}
  ]
}
```

**Pol√≠ticas de Gobierno Kafka**:
- ‚úÖ **Schema Registry obligatorio**: Confluent Schema Registry para todos los topics
- ‚úÖ **Schema evolution**: Backward compatibility (agregar campos opcionales OK, borrar/cambiar tipo NO)
- ‚úÖ **Idempotence**: Producers con `enable.idempotence=true`
- ‚úÖ **Acks**: `acks=all` para eventos cr√≠ticos (Payment, Ledger)
- ‚úÖ **Consumer Groups**: Naming convention `service-name-topic-name-consumer`

---

## üåê Kong API Gateway - Configuraci√≥n

### Routing & Load Balancing

```yaml
services:
  - name: payment-service
    url: http://payment-service.finscale.svc.cluster.local:8080
    
    routes:
      - name: payment-route
        paths:
          - /api/v1/payments
        methods:
          - GET
          - POST
          - PUT
          - DELETE
        strip_path: false
    
    plugins:
      - name: rate-limiting
        config:
          minute: 1000
          policy: redis
          redis_host: redis.finscale.svc.cluster.local
          redis_port: 6379
          
      - name: correlation-id
        config:
          header_name: X-Request-ID
          generator: uuid
          
      - name: request-size-limiting
        config:
          allowed_payload_size: 10  # 10 MB max
          
      - name: response-ratelimiting
        config:
          limits:
            second: 100
          
      - name: jwt
        config:
          key_claim_name: kid
          secret_is_base64: false
          claims_to_verify:
            - exp
            - nbf
```

### Traffic Splitting (Strangler Fig Migration)

```yaml
services:
  - name: payment-service-new
    url: http://payment-service.finscale.svc:8080
    
  - name: payment-service-legacy
    url: http://legacy-monolith.internal:8080

routes:
  - name: payment-route-canary
    paths:
      - /api/v1/payments
    
    plugins:
      - name: canary
        config:
          # Fase 1: 10% tr√°fico nuevo
          percentage: 10
          upstream_host: payment-service-new
          upstream_fallback_host: payment-service-legacy
```

**Pol√≠tica de Rollout**:
- Mes 1-4: 10% nuevo (validaci√≥n)
- Mes 5-9: 70% nuevo (producci√≥n)
- Mes 10-12: 100% nuevo (legacy apagado)

---

## ÔøΩüìú API Lifecycle Management

### Stages

```
1. DRAFT
   ‚îú‚îÄ OpenAPI spec creado
   ‚îú‚îÄ Review en Architecture Board
   ‚îî‚îÄ Aprobaci√≥n

2. BETA
   ‚îú‚îÄ Implementado en staging
   ‚îú‚îÄ Disponible para early adopters
   ‚îú‚îÄ Feedback collection (2-4 semanas)
   ‚îî‚îÄ Refinement

3. GA (Generally Available)
   ‚îú‚îÄ Producci√≥n
   ‚îú‚îÄ SLA: 99.9%
   ‚îú‚îÄ Monitoreo 24/7
   ‚îî‚îÄ Soporte completo

4. DEPRECATED
   ‚îú‚îÄ Sunset header en responses
   ‚îú‚îÄ Migration guide publicada
   ‚îú‚îÄ 12 meses de soporte paralelo
   ‚îî‚îÄ Notificaciones a clientes

5. RETIRED
   ‚îú‚îÄ API desactivada
   ‚îú‚îÄ HTTP 410 Gone
   ‚îî‚îÄ Redirect a nueva versi√≥n
```

---

### OpenAPI 3.0 Specification

```yaml
openapi: 3.0.3
info:
  title: FinScale Payments API
  version: 2.0.0
  description: |
    API para crear, consultar y gestionar pagos internacionales.
    
    ## Rate Limits
    - Free: 10 req/min
    - Pro: 1,000 req/min
    
    ## Authentication
    OAuth 2.0 con scope `payment:create`
  
  contact:
    email: api-support@finscale.com
  
  license:
    name: Proprietary
  
servers:
  - url: https://api.finscale.com/v2
    description: Production
  - url: https://api-staging.finscale.com/v2
    description: Staging

security:
  - OAuth2: [payment:create, payment:read]

paths:
  /payments:
    post:
      summary: Create a new payment
      operationId: createPayment
      tags:
        - Payments
      security:
        - OAuth2: [payment:create]
      
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreatePaymentRequest'
      
      responses:
        '201':
          description: Payment created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Payment'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '429':
          $ref: '#/components/responses/RateLimitExceeded'

components:
  schemas:
    CreatePaymentRequest:
      type: object
      required:
        - originator_id
        - beneficiary
        - amount
      properties:
        originator_id:
          type: string
          description: Customer ID
          example: "cust_123"
        beneficiary:
          $ref: '#/components/schemas/Beneficiary'
        amount:
          $ref: '#/components/schemas/Money'
        description:
          type: string
          maxLength: 140
          example: "Invoice #1234"
    
    Money:
      type: object
      required: [value, currency]
      properties:
        value:
          type: number
          format: double
          example: 500.00
        currency:
          type: string
          pattern: '^[A-Z]{3}$'
          example: "EUR"
  
  securitySchemes:
    OAuth2:
      type: oauth2
      flows:
        clientCredentials:
          tokenUrl: https://auth.finscale.com/oauth2/token
          scopes:
            payment:create: Create payments
            payment:read: Read payments
```

---

## üìä Monitoreo de APIs

### SLI (Service Level Indicators)

```yaml
Metrics:
  Availability:
    Formula: (successful_requests / total_requests) √ó 100
    Target: 99.9%
    Alert: < 99.5%
  
  Latency:
    Metric: api_request_duration_seconds{quantile="0.99"}
    Target: p99 < 500ms
    Alert: p99 > 1s
  
  Error Rate:
    Formula: (5xx_responses / total_requests) √ó 100
    Target: < 0.1%
    Alert: > 1%
  
  Throughput:
    Metric: api_requests_total (rate per second)
    Capacity: 10,000 req/s
    Alert: > 8,000 req/s (80% capacity)
```

### Grafana Dashboard

```promql
# Latency p99 por endpoint
histogram_quantile(0.99, 
  sum(rate(http_request_duration_seconds_bucket{job="payment-service"}[5m])) 
  by (le, endpoint)
)

# Error rate √∫ltimas 24h
sum(rate(http_requests_total{status=~"5.."}[24h])) 
/ 
sum(rate(http_requests_total[24h]))

# Top 10 endpoints m√°s lentos
topk(10, 
  histogram_quantile(0.99, 
    sum(rate(http_request_duration_seconds_bucket[1h])) by (le, endpoint)
  )
)
```

---

## üîí Security & Compliance

### API Security Checklist

- [x] HTTPS obligatorio (TLS 1.2+)
- [x] OAuth 2.0 authentication
- [x] JWT signature validation (RS256)
- [x] Rate limiting (por cliente)
- [x] Input validation (OpenAPI schema)
- [x] Output sanitization (no PII en logs)
- [x] CORS configurado (whitelist de dominios)
- [x] CSRF tokens (para APIs web)
- [x] API key rotation (90 d√≠as)
- [x] Audit logging (qui√©n hizo qu√©)

### PCI-DSS Compliance

```yaml
Requirements:
  - No almacenar CVV (solo tokenize)
  - Logs sin PAN (Primary Account Number)
  - Encryption at rest (AES-256)
  - TLS 1.2+ in transit
  - Quarterly vulnerability scans
```

---

**Pr√≥ximo Paso**: ‚Üí `5.3-Data-Governance.md`

---

**√öltima actualizaci√≥n**: 7 de diciembre de 2025
