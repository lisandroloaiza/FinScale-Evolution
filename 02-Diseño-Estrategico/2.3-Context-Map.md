# 2.3 Context Map (Mapa de Contexto)

> **Objetivo**: Visualizar las relaciones entre Bounded Contexts y equipos.  
> **T√©cnica**: DDD Context Mapping Patterns

---

## üó∫Ô∏è Patrones de Relaci√≥n entre Contextos

### Tipos de Relaciones (DDD)

| Patr√≥n | Descripci√≥n | Cu√°ndo Usar |
|--------|-------------|-------------|
| **Partnership** | Equipos colaboran estrechamente, √©xito mutuo | Contextos Core interdependientes |
| **Customer-Supplier** | Upstream (proveedor) sirve a Downstream (cliente) | Dependencia unidireccional clara |
| **Conformist** | Downstream acepta modelo del Upstream sin negociaci√≥n | Integraci√≥n con sistema externo legacy |
| **Anti-Corruption Layer (ACL)** | Downstream se protege con capa de traducci√≥n | Integraci√≥n con sistemas externos complejos |
| **Open Host Service (OHS)** | Upstream expone API p√∫blica est√°ndar | APIs p√∫blicas o multi-consumidor |
| **Published Language** | Modelo compartido bien definido (ej. JSON Schema) | Integraciones estandarizadas |
| **Shared Kernel** | C√≥digo compartido entre contextos (usar con precauci√≥n) | Sub-equipos del mismo dominio Core |
| **Separate Ways** | Contextos completamente independientes | Sin dependencias funcionales |

---

## üìä Context Map de FinScale Evolution

```mermaid
---
config:
  layout: elk
---
flowchart TB
 subgraph EXTERNAL["üåê SISTEMAS EXTERNOS"]
        SWIFT["SWIFT Network<br>(ISO 20022)"]
        CARDS["Visa/Mastercard<br>(ISO 8583)"]
        ACH["ACH/SEPA/PIX<br>Redes Locales"]
        KYC["KYC Providers<br>(Jumio/Onfido)"]
        SCREENING["AML Providers<br>(World-Check)"]
        FX_EXT["FX Brokers<br>Externos"]
  end
 subgraph CORE["üî¥ CORE DOMAIN"]
        PE["Payment Execution<br>Context"]
        FD["Fraud Detection<br>Context"]
        GL["General Ledger<br>Context"]
  end
 subgraph SUPP_HIGH["üü† SUPPORTING - Alta Complejidad"]
        RC["Reconciliation<br>Context"]
        CS["Clearing &amp; Settlement<br>Context"]
        TR["Treasury &amp; FX<br>Context"]
        RR["Regulatory Reporting<br>Context"]
  end
 subgraph SUPP_LOW["üü° SUPPORTING - Baja Complejidad"]
        CM["Customer Management<br>Context"]
        SC["Screening &amp; Compliance<br>Context"]
  end
 subgraph GEN["üü¢ GENERIC"]
        IA["Identity &amp; Access<br>Context"]
  end
    PE <-- Partnership --> GL
    PE -- "Customer-Supplier<br>Risk Scoring" --> FD
    FD -- "Customer-Supplier<br>Historial TX" --> GL
    PE -- "Customer-Supplier<br>Settlement Request" --> CS
    PE -- "Customer-Supplier<br>FX Quote" --> TR
    PE -- "Customer-Supplier<br>Customer Data" --> CM
    PE -- "Customer-Supplier<br>Screening Result" --> SC
    GL -- OHS<br>Ledger Events --> RC
    CS -- OHS<br>Bank Statements --> RC
    CS -- ACL<br>Conformist --> SWIFT & CARDS & ACH
    CS -- OHS<br>Settlement Events --> PE
    TR -- ACL<br>Conformist --> FX_EXT
    TR -- OHS<br>Treasury Data --> RR
    CM -- ACL<br>Conformist --> KYC
    CM -- "Customer-Supplier<br>UserId Mapping" --> IA
    GL -- OHS<br>CQRS Read Model --> CM
    SC -- ACL<br>Conformist --> SCREENING
    CM -- "Customer-Supplier<br>Screening Request" --> SC
    GL -- OHS<br>Transaction Logs --> RR
    CM -- "Customer-Supplier<br>KYC Data" --> RR
    IA -. JWT Validation<br>Stateless .-> PE & CM

    style EXTERNAL fill:#f0f0f0,stroke:#666
    style CORE fill:#ffcccc
    style SUPP_HIGH fill:#ffe6cc
    style SUPP_LOW fill:#fff4cc
    style GEN fill:#ccffcc
```

---

## üîó Descripci√≥n Detallada de Relaciones

### 1. Payment Execution ‚Üî General Ledger (Partnership)

**Relaci√≥n**: Partnership (Colaboraci√≥n estrecha)  
**Upstream**: Payment Execution Context  
**Downstream**: General Ledger Context  
**Justificaci√≥n**: Ambos son Core Domains. Un pago sin registro contable (doble entrada) es inv√°lido. Requiere coordinaci√≥n estrecha entre equipos.

**Integraci√≥n**:
- Payment Execution emite eventos de dominio:
  - `PaymentExecuted`: Cuando el pago fue enviado exitosamente a la red de clearing
  - `PaymentFailed`: Cuando el pago fue rechazado o fall√≥
  - `PaymentSettled`: Cuando se recibe confirmaci√≥n de liquidaci√≥n final
- General Ledger consume eventos y crea:
  - `LedgerEntry` (doble entrada): Cuenta Debe, Cuenta Haber, Monto, Currency, Timestamp at√≥mico
  - Actualizaci√≥n de `Balance` por cuenta y divisa
- **Consistencia**: Eventual (< 1s de lag aceptable). El saldo del cliente refleja el pago en menos de 1 segundo.
- **Contrato**: Event-Driven (Kafka topics + Avro schemas versionados)

**Patr√≥n de Resiliencia**: Si Ledger falla, Payment contin√∫a operando. Eventos quedan en cola para procesamiento posterior.

**Equipos**: 
- **Payment Core Team** (12 devs)
- **System of Record Team** (10 devs)  
- Ceremonias conjuntas: Refinement semanal, Retrospectivas compartidas

---

### 2. Payment Execution ‚Üí Fraud Detection (Customer-Supplier)

**Relaci√≥n**: Customer-Supplier  
**Upstream**: Fraud Detection Context (proveedor de servicio)  
**Downstream**: Payment Execution Context (cliente consumidor)

**Integraci√≥n**:
- Payment Execution solicita an√°lisis de riesgo antes de ejecutar el pago:
  - Endpoint: `POST /fraud/v1/assess`
  - Request: `{ paymentId, customerId, amount, currency, beneficiaryCountry, ipAddress, deviceFingerprint }`
  - Response: `{ riskScore: 0-100, decision: "APPROVE"|"REJECT"|"REVIEW", factors: [...] }`
- **SLA cr√≠tico**: Respuesta en < 100ms (P99)
- **Fail-Safe**: Si timeout o servicio ca√≠do, Payment aplica regla por defecto:
  - Montos < $1000: APPROVE autom√°tico
  - Montos >= $1000: REVIEW manual

**Contrato**: API REST + Circuit Breaker (Resilience4j) + Fallback

**Patr√≥n de Resiliencia**: Circuit Breaker con 3 estados (Closed/Open/Half-Open). Timeout: 100ms.

**Equipos**:
- **Payment Core Team** (downstream)
- **Trust & Safety Team** (upstream) - 8 devs (ML Engineers + Backend)

---

### 3. Payment Execution ‚Üí Clearing & Settlement (Customer-Supplier con OHS)

**Relaci√≥n**: Customer-Supplier con Open Host Service  
**Upstream**: Clearing & Settlement Context (proveedor)  
**Downstream**: Payment Execution Context (cliente)

**Integraci√≥n**:
- Payment Execution env√≠a instrucci√≥n de liquidaci√≥n:
  - Evento: `SettlementInstructionCreated`
  - Payload: `{ paymentId, network: "SWIFT"|"SEPA"|"PIX"|"SPEI"|"ACH", beneficiaryIBAN, amount, currency }`
- Clearing & Settlement emite eventos de respuesta:
  - `SettlementSent`: Mensaje enviado a la red externa
  - `SettlementConfirmed`: ACK recibido de la red (liquidaci√≥n exitosa)
  - `SettlementFailed`: NACK recibido (error en la red)
- Payment Execution consume eventos y actualiza m√°quina de estados:
  - `SENT_TO_GATEWAY` ‚Üí `CLEARING` ‚Üí `SETTLED` / `FAILED`

**Contrato**: Event-Driven (Kafka topics) + OHS (API de consulta de estado)

**Equipos**:
- **Payment Core Team** (downstream)
- **Global Operations Team** (upstream) - 6 devs

---

### 4. Clearing & Settlement ‚Üí Redes Externas (ACL + Conformist)

**Relaci√≥n**: Conformist con Anti-Corruption Layer  
**Upstream**: Redes bancarias externas (sin control de FinScale)  
**Downstream**: Clearing & Settlement Context

**Sistemas Externos (por red)**:
1. **SWIFT Network**:
   - Protocolo: ISO 20022 (pacs.008 para pagos, pacs.002 para confirmaciones)
   - Transporte: Host-to-Host (H2H) con conexi√≥n TCP persistente
   - Latencia: 2-5 minutos para liquidaci√≥n

2. **Visa/Mastercard**:
   - Protocolo: ISO 8583 (legacy, sockets TCP)
   - SLA: < 200ms para autorizaciones
   - Desaf√≠o: Conexiones stateful en ambiente Kubernetes ef√≠mero

3. **Redes Locales** (ACH/SEPA/PIX/SPEI):
   - Var√≠a por pa√≠s:
     - **SEPA** (Europa): ISO 20022 v√≠a SFTP (batch)
     - **PIX** (Brasil): API REST inmediata
     - **SPEI** (M√©xico): API REST/SOAP
     - **ACH** (USA): Archivos batch v√≠a SFTP

**Anti-Corruption Layer (ACL)**:
- Clearing implementa Adapters espec√≠ficos por red:
  - `SWIFTAdapter`: Traduce `SettlementInstruction` ‚Üí mensaje ISO 20022 (XML)
  - `ISO8583Adapter`: Traduce a formato binario para Visa/Mastercard
  - `PIXAdapter`: Traduce a JSON para API PIX del Banco Central de Brasil
- **Patr√≥n**: Adapter Pattern + Protocol Translator + Wrapper sobre protocolos legacy

**Conformist**: FinScale NO controla los cambios en estas redes. Si SWIFT actualiza su esquema ISO 20022, FinScale debe adaptarse.

**Resiliencia**:
- Si SEPA cae: FinScale encola instrucciones y reintenta (exponential backoff)
- Si Visa/Mastercard rechazan conexi√≥n: Circuit Breaker + Fallback a red alternativa

**Equipos**:
- **Global Operations Team** (6 devs) - Propietarios del ACL

---

### 5. General Ledger ‚Üí Reconciliation (OHS con Read Models)

**Relaci√≥n**: Open Host Service (Ledger expone m√∫ltiples interfaces)  
**Upstream**: General Ledger Context (proveedor)  
**Downstream**: Reconciliation Context (consumidor)

**Integraci√≥n Dual**:
1. **Streaming (tiempo real)**:
   - Ledger publica eventos de dominio: `LedgerEntryCreated`
   - Reconciliation consume v√≠a Kafka Consumer y procesa en streaming
   - Objetivo: Eliminar batch window nocturna de 6 horas

2. **Batch (consulta hist√≥rica)**:
   - Ledger expone Read API: `GET /ledger/v1/entries?startDate=X&endDate=Y`
   - Reconciliation usa API para obtener lote hist√≥rico al recibir extractos bancarios

**Proceso de Reconciliaci√≥n** (seg√∫n kata):
1. A las 00:00 UTC, Reconciliation descarga extractos de bancos aliados (MT940/CAMT.053)
2. Cruza cada movimiento bancario contra Ledger interno (streaming + batch)
3. Si detecta desviaci√≥n (ej. banco dice $100, ledger dice $90):
   - Crea `DiscrepancyCase` con nivel cr√≠tico
   - Alerta al equipo de operaciones manuales

**Objetivo del Nuevo Dise√±o**: Reconciliaci√≥n continua (no bloquear BD por 6 horas)

**Equipos**:
- **System of Record Team** (upstream) - 10 devs
- **System of Record Team** (downstream) - Mismo equipo maneja ambos contextos por cohesi√≥n de dominio contable

---

### 6. Customer Management ‚Üí External KYC Providers (ACL + Conformist)

**Relaci√≥n**: Conformist con Anti-Corruption Layer  
**Upstream**: Proveedores KYC externos (Jumio, Onfido) - sin control de FinScale  
**Downstream**: Customer Management Context

**Proveedores Externos** (seg√∫n kata):
- **Jumio**: Verificaci√≥n de documentos de identidad (pasaportes, c√©dulas)
- **Onfido**: Verificaci√≥n biom√©trica (selfies, liveness detection)
- **Integraci√≥n**: Webhooks as√≠ncronos

**Flujo de Onboarding** (seg√∫n kata):
1. Cliente carga foto de ID y selfie biom√©trico en la App
2. Customer Management env√≠a a proveedor KYC:
   - Request: `{ documentImage, selfieImage, personalData }`
3. Proveedor responde **minutos despu√©s** v√≠a webhook:
   - `{ kycStatus: "APPROVED"|"REJECTED"|"REVIEW", confidence: 0.95, ... }`
4. Customer Management actualiza `Customer.kycStatus` y `Customer.onboardingState`

**Anti-Corruption Layer (ACL)**:
- Customer Management implementa adaptadores por proveedor:
  - `JumioAdapter`: Traduce `Customer` ‚Üí modelo Jumio `Subject`
  - `OnfidoAdapter`: Traduce `Customer` ‚Üí modelo Onfido `Applicant`
  - `KYCResponseNormalizer`: Normaliza respuestas heterog√©neas a modelo interno √∫nico
- **Justificaci√≥n**: Proteger Customer Context de cambios en APIs externas y permitir cambio de proveedor sin impacto

**Conformist**: FinScale NO controla el modelo de datos de Jumio/Onfido. Debe adaptarse a cambios.

**Equipos**:
- **Growth & Customer Experience Team** (5 devs) - Propietarios del ACL para KYC

---

### 7. Payment Execution ‚Üí Treasury & FX (Customer-Supplier)

**Relaci√≥n**: Customer-Supplier  
**Upstream**: Treasury & FX Context (proveedor)  
**Downstream**: Payment Execution Context (cliente)

**Integraci√≥n**:
- Payment Execution solicita cotizaci√≥n de cambio para pagos transfronterizos:
  - Endpoint: `POST /fx/v1/quote`
  - Request: `{ sourceCurrency: "USD", targetCurrency: "EUR", amount: 1000.00 }`
  - Response: `{ fxRate: 0.92, spread: 0.005, spotRate: 0.915, lockTimestamp, lockExpiresIn: 300 }` (5 minutos)
- Cliente confirma transacci√≥n antes de expiraci√≥n de bloqueo de tasa
- Treasury & FX ejecuta conversi√≥n y bloquea fondos temporalmente

**Proceso seg√∫n kata** (Transferencia Internacional P2P - "El Camino Feliz"):
1. Cliente inicia transferencia (USD a EUR)
2. Sistema cotiza tasa y la **bloquea por 5 minutos**
3. Cliente confirma con biometr√≠a
4. Motor de Fraude analiza (< 100ms)
5. Ledger debita USD y acredita cuenta puente interna
6. Tesorer√≠a instruye banco partner en Europa para pagar en EUR

**Contrato**: API REST s√≠ncrona (requiere respuesta inmediata para UX)

**Equipos**:
- **Payment Core Team** (downstream)
- **Global Operations Team** (upstream) - 4 devs dedicados a FX & Treasury

---

### 8. Screening & Compliance ‚Üí External AML Providers (ACL + Conformist)

**Relaci√≥n**: Conformist con Anti-Corruption Layer  
**Upstream**: Proveedores AML externos (World-Check, ComplyAdvantage)  
**Downstream**: Screening & Compliance Context

**Proveedores Externos** (seg√∫n kata):
- **World-Check** (Refinitiv): Listas negras globales (OFAC, Interpol, PEP)
- **ComplyAdvantage**: Screening de sanciones en tiempo real

**Integraci√≥n**:
- Screening solicita verificaci√≥n de ordenante y beneficiario:
  - Request: `{ fullName, dateOfBirth, nationality, country }`
  - Response: `{ matchFound: true|false, watchlistType: "OFAC"|"PEP"|"INTERPOL", confidence: 0.85 }`
- **Requisito regulatorio cr√≠tico**: Verificaci√≥n obligatoria antes de ejecutar pago
- **Algoritmo**: Fuzzy search (matching de nombres con similitud)

**Anti-Corruption Layer (ACL)**:
- Screening implementa cache local de listas negras (actualizaci√≥n diaria)
- Normaliza respuestas de m√∫ltiples proveedores a modelo interno `ScreeningCase`
- Traduce falsos positivos: Si match con confianza < 70%, requiere revisi√≥n manual

**Contrato**: API REST + Cache Local (Redis) para reducir latencia

**Equipos**:
- **Trust & Safety Team** (3 devs) - Propietarios del Screening Context

---

### 9. Regulatory Reporting ‚Üê Multiple Contexts (OHS + Consumer)

**Relaci√≥n**: Open Host Service (m√∫ltiples proveedores)  
**Upstream**: General Ledger, Customer Management, Treasury & FX  
**Downstream**: Regulatory Reporting Context

**Integraci√≥n Multi-Source**:
1. **General Ledger** ‚Üí Regulatory Reporting:
   - Eventos: `TransactionLogsEnriched` (con trazabilidad completa de fondos)
   - Datos: Logs de transacciones, origen/destino de fondos, timestamps

2. **Customer Management** ‚Üí Regulatory Reporting:
   - API REST: `GET /customers/v1/{id}/kyc-data`
   - Datos: Informaci√≥n KYC, documentos fiscales (RUT/TaxID), estructura accionaria (B2B)

3. **Treasury & FX** ‚Üí Regulatory Reporting:
   - Eventos: `TreasuryDataPublished`
   - Datos: Operaciones de cambio, saldos en bancos corresponsales

**Proceso seg√∫n kata** (Regulatory Reporting):
- Generaci√≥n de reportes para bancos centrales, autoridades fiscales, entidades de supervisi√≥n
- Formatos definidos por reguladores (est√°ndares por pa√≠s/regi√≥n)
- Reportes de Operaciones Sospechosas (ROS/SAR) para compliance

**Contrato**: Event-Driven (async) + Query API (sync) seg√∫n necesidad

**Equipos**:
- **Trust & Safety Team** (propietarios de Regulatory Reporting)
- Consumidores de datos de: System of Record, Customer Experience, Global Operations

---

### 10. Identity & Access ‚Üí All Contexts (Stateless JWT Validation)

**Relaci√≥n**: Open Host Service (proveedor stateless)  
**Upstream**: Identity & Access Context (commodity)  
**Downstream**: Todos los contextos

**Integraci√≥n**:
- Identity & Access emite tokens JWT tras autenticaci√≥n:
  - Login exitoso ‚Üí `{ accessToken: "eyJ...", refreshToken: "...", expiresIn: 3600 }`
- Cada contexto valida tokens de forma **stateless** (sin llamar a Identity):
  - Verifican firma JWT con clave p√∫blica compartida
  - Extraen claims: `{ userId, customerId, roles: [...], permissions: [...] }`

**Autenticaci√≥n seg√∫n kata**:
- Gesti√≥n de credenciales, 2FA, recuperaci√≥n de claves, manejo de sesiones
- OAuth2/OIDC (protocolos est√°ndar completamente resueltos por la industria)

**Estrategia**: BUY - Proveedor SaaS (Auth0, AWS Cognito) o Open Source (Keycloak)

**Patr√≥n**: Sin dependencia runtime entre contextos e Identity (validaci√≥n local con JWT)

**Equipos**:
- **Platform Team** (2 devs) - Integraci√≥n y configuraci√≥n de proveedor SaaS

---

## üéØ Estrategia de Equipos (Conway's Law Inversa)

### Alineaci√≥n de Equipos con Bounded Contexts (seg√∫n estructura del kata)

| Bounded Context | Equipo Kata | Bounded Contexts | Devs | Autonom√≠a |
|-----------------|-------------|------------------|------|-----------|---------------|
| **Payment Execution** | Global Operations | Payment Execution | 12 | **Alta** - Equipo core, decisiones t√©cnicas independientes |
| **Fraud Detection** | Trust & Safety | Fraud Detection | 8 | **Alta** - ML Engineers + Backend, stack especializado |
| **General Ledger** | System of Record | General Ledger | 10 | **Alta** - Propietarios de la verdad financiera |
| **Reconciliation** | System of Record | Reconciliation | (incluido en SoR) | **Alta** - Mismo equipo por cohesi√≥n contable |
| **Clearing & Settlement** | Global Operations | Clearing & Settlement | 6 | **Media** - Coordinaci√≥n con Payment Execution |
| **Treasury & FX** | Global Operations | Treasury & FX | 4 | **Media** - Coordinaci√≥n con Payment Execution |
| **Regulatory Reporting** | Trust & Safety | Regulatory Reporting | 3 | **Media** - Consume datos de m√∫ltiples contextos |
| **Customer Management** | Growth & Customer Exp. | Customer Management | 5 | **Alta** - Propietarios de ciclo de vida del cliente |
| **Screening & Compliance** | Trust & Safety | Screening & Compliance | 3 | **Media** - Integraciones con proveedores externos |
| **Identity & Access** | Platform Engineering | Identity & Access | 2 | **Baja** - SaaS configurado (Auth0/Cognito) |

**Equipos del Kata** (seg√∫n documento original):
1. **Growth & Customer Experience** (Canales y Cliente) - Customer Onboarding, Account Access, Wallet Overview, Beneficiary Management
2. **Global Operations** (Tesorer√≠a y Procesamiento) - Payment Execution, FX Trading, Clearing & Settlement, Liquidity Management
3. **Trust & Safety** (Riesgo y Cumplimiento) - Fraud Detection, Sanctions Screening, Regulatory Reporting
4. **System of Record** (Contabilidad T√©cnica) - Position Keeping (Ledger), Reconciliation
5. **Platform Engineering** (Infraestructura) - API Gateway, Event Bus, Observability, DevOps, Identity & Access

**Principios Aplicados**:
- **Equipos peque√±os** (< 12 personas): Facilita comunicaci√≥n y autonom√≠a
- **Full-stack**: Cada equipo es due√±o de su contexto end-to-end (Frontend, Backend, BD, Deploy)
- **Conway's Law Inversa**: Estructura de equipos dise√±ada para reflejar la arquitectura deseada (Bounded Contexts independientes)
- **Autonom√≠a t√©cnica**: Cada equipo elige su stack dentro de lineamientos (ej. todos usan Spring Boot Reactive, pero eligen BD seg√∫n necesidad)

---

## ‚úÖ Decisiones de Dise√±o Estrat√©gicas

### 1. Patrones de Integraci√≥n por Tipo de Comunicaci√≥n

| Patr√≥n | Contextos | Justificaci√≥n |
|--------|-----------|---------------|
| **Event-Driven (async)** | Payment ‚Üí Ledger, Clearing ‚Üí Payment, Ledger ‚Üí Reconciliation | Resiliencia: Si consumidor cae, eventos quedan en cola. Desacoplamiento temporal. |
| **API REST s√≠ncrona** | Payment ‚Üí Fraud (< 100ms), Payment ‚Üí Treasury FX (UX) | Requiere respuesta inmediata para decisi√≥n de negocio (aprobar pago, mostrar tasa). |
| **Stateless JWT** | Identity ‚Üí Todos | Sin dependencia runtime. Validaci√≥n local con clave p√∫blica compartida. |
| **ACL (Anti-Corruption Layer)** | Clearing ‚Üí SWIFT/Visa, Customer ‚Üí KYC, Screening ‚Üí AML | Proteger modelo interno de cambios en sistemas externos. Permitir cambio de proveedor. |

### 2. Estrategia de Consistencia de Datos

| Contexto | Tipo de Consistencia | Justificaci√≥n (seg√∫n kata) |
|----------|---------------------|---------------------------|
| **General Ledger** | **Fuerte** (ACID) | Saldos deben ser exactos. No se puede debitar m√°s de lo disponible. Contabilidad de doble entrada inmutable. |
| **Payment Execution** | **Fuerte** (Event Sourcing) | Estado del pago (DRAFT ‚Üí VALIDATED ‚Üí SETTLED) debe ser determinista. Trazabilidad completa. |
| **Reconciliation** | **Eventual** (< 1s lag) | Aceptable que reconciliaci√≥n refleje ledger con 1 segundo de retraso. No impacta operaci√≥n 24/7. |
| **Customer Management (Wallet View)** | **Eventual** (CQRS) | Vista consolidada puede tener lag de 1-2 segundos. Cliente tolera peque√±o delay en visualizaci√≥n. |

### 3. Eliminaci√≥n de Dependencias Legadas (Deuda T√©cnica)

**Problema del Kata**: 
- 40% de l√≥gica de negocio en PL/SQL (Store Procedures de Oracle)
- Integraci√≥n por Shared Database (sistemas sat√©lites leen/escriben directamente en CORE_SCHEMA)
- Secuencias de Oracle centralizadas para IDs globales (cuello de botella)

**Estrategia de Migraci√≥n**:
1. **Strangler Fig Pattern**: Migrar gradualmente funcionalidad del monolito a microservicios
2. **Event Sourcing para IDs**: Reemplazar secuencias centralizadas con UUIDs distribuidos
3. **Database Refactoring**: Crear vistas de compatibilidad para sistemas sat√©lites legacy mientras migran a consumir APIs/eventos
4. **ACL para Monolito**: Nuevos contextos consumen/publican datos del monolito v√≠a ACL (no acceso directo a BD)

### 4. Resiliencia y Alta Disponibilidad (99.999%)

**Principio del Kata**: "Un fallo catastr√≥fico en una parte del ecosistema no debe afectar el procesamiento de pagos"

**Patrones Aplicados**:
- **Circuit Breaker**: Payment ‚Üí Fraud (si Fraud cae, Payment usa regla por defecto)
- **Retry con Exponential Backoff**: Clearing ‚Üí Redes externas (si SEPA cae, encolar y reintentar)
- **Event Sourcing**: Payment y Ledger pueden reconstruir estado completo desde eventos (disaster recovery)
- **CQRS**: Customer Management tiene Read Models desnormalizados. Si servicio cae, clientes ven √∫ltima snapshot.
- **Eliminaci√≥n de Batch Window**: Reconciliaci√≥n continua (streaming) reemplaza batch nocturno de 6 horas que bloqueaba BD

### 5. Gobierno de Datos y Trazabilidad (PCI-DSS, GDPR)

**Requisito del Kata**: "Cumplimiento estricto de PCI-DSS y GDPR, con trazabilidad total"

**Estrategia**:
- **Event Sourcing en Ledger y Payment**: Inmutabilidad garantiza trazabilidad completa (audit log)
- **Data Lineage**: Regulatory Reporting puede trazar origen y destino de fondos desde eventos de dominio
- **Encriptaci√≥n en Tr√°nsito y Reposo**: TLS 1.3 para comunicaci√≥n, AES-256 para datos sensibles en BD
- **HSM (Hardware Security Module)**: Llaves criptogr√°ficas para firmar transacciones residen en HSM (requisito PCI-DSS)
  - Desaf√≠o: Migrar de HSM f√≠sico on-premise a Cloud HSM (AWS CloudHSM, Azure Key Vault) sin interrumpir servicio
- **GDPR (Right to be Forgotten)**: Customer Management implementa mecanismo de anonimizaci√≥n (no borrado de eventos, sino enmascaramiento de PII)

---

**Pr√≥ximo Paso**: ‚Üí [2.4-Arquitectura-Objetivo.md](2.4-Arquitectura-Objetivo.md) - Diagramas C4 Model y dise√±o t√©cnico detallado

---

**√öltima actualizaci√≥n**: 22 de diciembre de 2025
